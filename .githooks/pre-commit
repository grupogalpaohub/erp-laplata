#!/usr/bin/env bash
set -e

CHANGED=$(git diff --cached --name-only)
export GIT_STAGED_LIST="$CHANGED"

echo "üîç [PRE-COMMIT] Verificando ${#CHANGED[@]} arquivos..."

# Nunca comitar .env.local (sem travar o resto do commit)
if echo "$CHANGED" | grep -qE '^\.env\.local$'; then
  echo "‚ùå N√£o commitar .env.local. Mantenha apenas local."
  exit 1
fi

# Se n√£o h√° arquivos cr√≠ticos, libera
if ! echo "$CHANGED" | grep -E '^(lib/(env|supabase)|app/auth/|middleware\.ts$|next\.config\.(js|mjs)$|supabase/|.*_schema\.sql$|.*_data\.sql$|migrations?/)' >/dev/null; then
  echo "‚úÖ [PRE-COMMIT] Nenhum arquivo cr√≠tico detectado. Liberando commit."
  exit 0
fi

echo "‚ö†Ô∏è  [PRE-COMMIT] Arquivos cr√≠ticos detectados. Executando preflight..."

# Arquivos cr√≠ticos: roda preflight hier√°rquico (sem pedir aprova√ß√£o humana)
node scripts/guardrails/preflight.js || {
  echo "‚ùå Preflight reprovou (auth/api/db/porta/schema). Leia o log acima."
  exit 2
}

echo "‚úÖ [PRE-COMMIT] Preflight aprovado. Liberando commit."