#!/usr/bin/env bash
set -e

CHANGED=$(git diff --cached --name-only)
export GIT_STAGED_LIST="$CHANGED"

# Nunca comitar .env.local (sem travar o resto do commit)
if echo "$CHANGED" | grep -qE '^\.env\.local$'; then
  echo "❌ Não commitar .env.local. Mantenha apenas local."
  exit 1
fi

# Se não há arquivos críticos, libera
if ! echo "$CHANGED" | grep -E '^(lib/(env|supabase)|app/auth/|middleware\.ts$|next\.config\.(js|mjs)$|supabase/|.*_schema\.sql$|.*_data\.sql$|migrations?/)' >/dev/null; then
  exit 0
fi

# Arquivos críticos: roda preflight hierárquico (sem pedir aprovação humana)
node scripts/guardrails/preflight.js || {
  echo "❌ Preflight reprovou (auth/api/db/porta/schema). Leia o log acima."
  exit 2
}